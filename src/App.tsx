import { useState, useCallback } from 'react';
import { useCamera } from './hooks/useCamera';
import { usePulseDetection } from './hooks/usePulseDetection';
import { CameraFeed } from './components/CameraFeed';
import { BPMDisplay } from './components/BPMDisplay';
import { WaveformChart } from './components/WaveformChart';
import { SignalQuality } from './components/SignalQuality';
import { Onboarding } from './components/Onboarding';
import { Controls } from './components/Controls';

export default function App() {
  const camera = useCamera();
  const pulse = usePulseDetection(camera.videoRef, camera.isActive);
  const [showOverlay, setShowOverlay] = useState(true);
  const [showHelp, setShowHelp] = useState(false);

  const handleStartCamera = useCallback(async () => {
    await camera.start();
  }, [camera]);

  const handleStopCamera = useCallback(() => {
    pulse.stop();
    camera.stop();
  }, [camera, pulse]);

  const handleStartMeasure = useCallback(() => {
    pulse.start();
  }, [pulse]);

  const handleStopMeasure = useCallback(() => {
    pulse.stop();
  }, [pulse]);

  return (
    <div className="flex min-h-screen flex-col bg-bg-primary">
      <Onboarding />
      {showHelp && (
        <Onboarding forceShow onDismiss={() => setShowHelp(false)} />
      )}

      <main className="mx-auto w-full max-w-2xl flex-1 px-4 pt-5 pb-4">
        {/* Minimal top bar */}
        <div className="mb-4 flex items-center justify-between">
          <h1 className="text-xs font-semibold tracking-[0.2em] text-text-secondary/60 uppercase">
            PulseCam
          </h1>
          <button
            onClick={() => setShowHelp(true)}
            className="flex h-7 w-7 items-center justify-center rounded-full text-sm text-text-secondary/40 transition-colors hover:bg-bg-secondary hover:text-text-secondary"
            aria-label="Show help and instructions"
          >
            ?
          </button>
        </div>

        {/* Error */}
        {camera.error && (
          <p className="mb-3 text-center text-sm text-pulse-red" role="alert">
            {camera.error}
          </p>
        )}

        {/* Loading */}
        {pulse.state === 'loading' && pulse.loadingMessage && (
          <p className="mb-3 text-center text-sm text-accent/70">
            {pulse.loadingMessage}
          </p>
        )}

        {/* Camera */}
        <CameraFeed
          videoRef={camera.videoRef}
          faceROI={pulse.faceROI}
          faceDetected={pulse.faceDetected}
          showOverlay={showOverlay}
          isActive={camera.isActive}
        />

        {/* Controls */}
        <div className="mt-3">
          <Controls
            isRunning={pulse.isRunning}
            cameraActive={camera.isActive}
            onStartCamera={handleStartCamera}
            onStopCamera={handleStopCamera}
            onStartMeasure={handleStartMeasure}
            onStopMeasure={handleStopMeasure}
            devices={camera.devices}
            selectedDevice={camera.selectedDevice}
            onSelectDevice={camera.selectDevice}
            showOverlay={showOverlay}
            onToggleOverlay={() => setShowOverlay((s) => !s)}
          />
        </div>

        {/* BPM + Signal Quality */}
        <div className="mt-6">
          <BPMDisplay
            bpm={pulse.bpm}
            state={pulse.state}
            confidence={pulse.confidence}
          />
          <SignalQuality
            quality={pulse.quality}
            isActive={pulse.isRunning}
          />
        </div>

        {/* Waveform */}
        {pulse.isRunning && (
          <div className="mt-5">
            <WaveformChart
              waveform={pulse.waveform}
              isActive={pulse.isRunning}
            />
          </div>
        )}
      </main>

      {/* Disclaimer */}
      <footer className="px-4 pb-4 pt-2">
        <p className="mx-auto max-w-2xl text-center text-[11px] text-text-secondary/40">
          For educational use only â€” not a medical device. All processing happens on your device.
        </p>
      </footer>
    </div>
  );
}
